<!DOCTYPE html>
<html>
<head>
  <title>NFC Card Data</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    pre { background: #f0f0f0; padding: 1rem; }
  </style>
</head>
<body>
  <h1>NFC Card Status</h1>
  
  <p><strong>Reader:</strong> <span id="reader">Waiting for Reader...</span></p>
  <p><strong>Card Status:</strong> <span id="card">Waiting for Card..</span></p>
  <p><strong>User ID:</strong> <span id="userID">Waiting for Card...</span></p>
  <p><strong>Hash:</strong> <span id="hash">Waiting for Card...</span></p>
  <p><strong>Name:</strong> <span id="name">Waiting for Card...</span></p>
  <p><strong>Role:</strong> <span id="role">Waiting for Card...</span></p>
  <p><strong>Password:</strong> <span id="pass">Waiting for Card...</span></p>
  <p><strong>NFC Token:</strong> <span id="tokn">Waiting for Card...</span></p>
  <p><strong>Session:</strong> <span id="sess">...</span></p>
  <button onclick=getSessions()>Get Sessions</button>
  <button onclick=fetchCardData()>Refresh</button>
  <button onclick=getReaderStatus()>Get Reader Status</button>
  <p><strong>Write Into Card:</strong></p>
  <textarea id="write" rows="5" cols="40" placeholder='{ "role": "", "name": "", "password": "" }'></textarea>
  <br>
  <button id="write-btn" onclick="writeToCard()">Write</button>
  <p id="write-status"></p>

  <script>
    let userID = document.getElementById('userID');
    let hash = document.getElementById('hash');
    let card = document.getElementById('card');
    let name = document.getElementById('name');
    let role = document.getElementById('role');
    let pass = document.getElementById('pass');
    let sess = document.getElementById('sess');
    let tokn = document.getElementById('tokn');

    async function getReaderStatus() {
      try {
        const res = await fetch('/nfc/check-reader');
        const data = await res.json();

        if(data.connected === true){
          document.getElementById('reader').textContent = 'Connected';
        } else if (data.connected === false){
          document.getElementById('reader').textContent = 'Disconnected';
        } else if (!res) {
          document.getElementById('reader').textContent = 'Error';
        }
      } catch (err){
        document.getElementById('reader').textContent = 'Error';
      }
    }

    async function fetchCardData() {
      const btn = document.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Reading...';

      userID.textContent = 'Waiting for Card...';
      hash.textContent = 'Waiting for Card...';
      card.textContent = 'Waiting for Card...';
      name.textContent = 'Waiting for Card...';
      role.textContent = 'Waiting for Card...';
      pass.textContent = 'Waiting for Card...';
      tokn.textContent = 'Waiting for Card...';
      
      try {
        const res = await fetch('/nfc/read');
        const data = await res.json();

        document.getElementById('card').textContent = 'Reading...';

        if (data && data.valid) {
          userID.textContent = data.userID ?? 'N/A';
          hash.textContent = data.hash ?? 'No hash'; // âœ… fix here
          card.textContent = 'Read';
          name.textContent = data.firstName ?? 'N/A';
          role.textContent = data.middleName ?? 'N/A';
          pass.textContent = data.lastName ?? 'N/A';
          tokn.textContent = data.token ?? 'N/A';

        } else if (data && !data.valid) {
          userID.textContent = 'Invalid card data';
          hash.textContent = `Couldn't fetch`;
          card.textContent = 'Read';
          name.textContent = 'Invalid card data';
          role.textContent = 'Invalid card data';
          pass.textContent = 'Invalid card data';

        } else {
          userID.textContent = 'Waiting for Card...';
          hash.textContent = 'Waiting for Card...';
          card.textContent = 'Waiting for Card...';
          name.textContent = 'Waiting for Card...';
          role.textContent = 'Waiting for Card...';
          pass.textContent = 'Waiting for Card...';
        }
      } catch (err) {
        console.error("Card read error:", err); // ðŸ‘ˆ log actual error
        userID.textContent = 'Error reading card';
        hash.textContent = `Couldn't fetch`;
        card.textContent = 'Error reading card';
        name.textContent = 'Error reading card';
        role.textContent = 'Error reading card';
        pass.textContent = 'Error reading card';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Refresh';
      }
    }

    async function writeToCard() {
      const btn = document.getElementById('write-btn');
      const textarea = document.getElementById('write');
      const statusElem = document.getElementById('write-status');
      const cardElem = document.getElementById('card');
      const jsonText = textarea.value.trim();

      let jsonData;
      try {
        jsonData = JSON.parse(jsonText);
      } catch {
        statusElem.textContent = 'Invalid JSON. Please check your input.';
        statusElem.style.color = 'red';
        cardElem.textContent = '';
        return;
      }

      btn.textContent = 'Writing...';
      statusElem.textContent = 'Writing to card...';
      statusElem.style.color = 'orange';
      cardElem.textContent = 'Writing to card...';

      try {
        const res = await fetch('/nfc/write', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(jsonData),
        });

        const data = await res.json();

        if (data.success) {
          statusElem.textContent = 'Successfully written to card.';
          statusElem.style.color = 'green';
          cardElem.textContent = 'Card write complete.';
        } else {
          statusElem.textContent = 'Failed to write to card.';
          statusElem.style.color = 'red';
          cardElem.textContent = 'Failed to write to card.';
        }
      } catch (err) {
        console.error('Write error:', err);
        statusElem.textContent = 'Error writing to card.';
        statusElem.style.color = 'red';
        cardElem.textContent = 'Error writing to card.';
      } finally {
        btn.textContent = 'Write';
      }
    };

    async function getSessions() {
      try {
        const result = await fetch("/session/current-sessions", { credentials: "include" });
        if (!result) {
          sess.textContent = result;
        } else {
          sess.textContent = result;
        };
      } catch (err) {
        sess.textContent = "..."
      }
    };
    
  </script>
</body>
</html>
